name: Process Volunteer Submission

on:
  issues:
    types: [opened]

jobs:
  process-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install clicksend-client
          pip install ics
          pip install pyyaml

      - name: Extract volunteer name and shifts from issue body
        id: extract
        run: |
          # Debug: print event path and issue body JSON
          echo "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

          # Extract issue body text
          ISSUE_BODY=$(jq -r .issue.body "$GITHUB_EVENT_PATH")

          # Extract volunteer name after "### Full Name" heading
          NAME=$(echo "$ISSUE_BODY" | sed -n '/### Full Name/{n;p;}' | xargs)

          # Extract shifts block after "### What shifts are you available for?"
          SHIFTS=$(echo "$ISSUE_BODY" | awk '/### What shifts are you available for\?/{flag=1; next} /^### /{flag=0} flag' | sed '/^\s*$/d' | tr '\n' ' ' | xargs)

          echo "Extracted name: '$NAME'"
          echo "Extracted shifts: '$SHIFTS'"

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "shifts=$SHIFTS" >> $GITHUB_OUTPUT

      - name: Run parse_issue.py script
        run: |
          echo "Name: '${{ steps.extract.outputs.name }}'"
          echo "Shifts: '${{ steps.extract.outputs.shifts }}'"

          python parse_issue.py --name "${{ steps.extract.outputs.name }}" --shifts "${{ steps.extract.outputs.shifts }}"
