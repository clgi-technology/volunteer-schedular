name: Process Volunteer Submission

on:
  issues:
    types: [opened]

jobs:
  process-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install clicksend-client
          pip install ics
          pip install pyyaml

      - name: Extract volunteer name and shifts from issue body
        id: extract
        run: |
          # For debugging: show the event file contents
          echo "GITHUB_EVENT_PATH contents:"
          cat "$GITHUB_EVENT_PATH"

          # Extract the full issue body
          ISSUE_BODY=$(jq -r .issue.body "$GITHUB_EVENT_PATH")

          # Extract name under "### Full Name" heading (trim whitespace)
          NAME=$(echo "$ISSUE_BODY" | awk '
            BEGIN {found=0}
            /### Full Name/ {found=1; next}
            found && /^[[:space:]]*$/ {next}
            found {print; exit}
          ' | xargs)

          # Extract shifts under "### What shifts are you available for?" heading until next heading
          SHIFTS=$(echo "$ISSUE_BODY" | awk '
            /### What shifts are you available for\?/ {flag=1; next}
            /^### / {flag=0}
            flag
          ' | sed '/^\s*$/d' | tr '\n' ' ' | xargs)

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "shifts=$SHIFTS" >> $GITHUB_OUTPUT

      - name: Run parse_issue.py script
        run: |
          echo "Name: '${{ steps.extract.outputs.name }}'"
          echo "Shifts: '${{ steps.extract.outputs.shifts }}'"

          python parse_issue.py --name "${{ steps.extract.outputs.name }}" --shifts "${{ steps.extract.outputs.shifts }}"
