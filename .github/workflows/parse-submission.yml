name: Parse Volunteer Submission

on:
  issues:
    types: [opened]

jobs:
  parse-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install clicksend-client ics pyyaml

      - name: Extract volunteer name, phone, and shifts
        id: extract
        run: |
          ISSUE_BODY=$(jq -r .issue.body "$GITHUB_EVENT_PATH")

          echo "ðŸ“„ Raw issue body:"
          echo "$ISSUE_BODY"
          echo "-----"

          NAME=$(echo "$ISSUE_BODY" | sed -n '/ðŸ‘¤ Name:/ {n;p;}' | xargs)
          PHONE=$(echo "$ISSUE_BODY" | sed -n '/ðŸ“± Phone:/ {n;p;}' | xargs)
          SHIFTS=$(echo "$ISSUE_BODY" | awk '/ðŸ“† Shifts:/ {flag=1; next} /^$/ {flag=0} flag' | xargs)

          echo "ðŸ‘¤ Name: $NAME"
          echo "ðŸ“± Phone: $PHONE"
          echo "ðŸ“† Shifts: $SHIFTS"

          if [ -z "$NAME" ] || [ -z "$SHIFTS" ]; then
            echo "âŒ Error: Missing required 'name' or 'shifts'"
            exit 1
          fi

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "phone=$PHONE" >> $GITHUB_OUTPUT
          echo "shifts=$SHIFTS" >> $GITHUB_OUTPUT

      - name: Run parse_issue.py
        run: |
          python parse_issue.py \
            --name "${{ steps.extract.outputs.name }}" \
            --phone "${{ steps.extract.outputs.phone }}" \
            --shifts "${{ steps.extract.outputs.shifts }}"
