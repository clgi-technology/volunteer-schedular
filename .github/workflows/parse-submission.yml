name: Parse Volunteer Submission

on:
  issues:
    types: [opened]

jobs:
  parse-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install clicksend-client ics pyyaml

      - name: Extract volunteer name, phone and shifts from issue body
        id: extract
        run: |
          ISSUE_BODY=$(jq -r .issue.body "$GITHUB_EVENT_PATH")

          echo "ðŸ“„ Raw issue body:"
          echo "$ISSUE_BODY"
          echo "-----"

          # Extract first non-empty line after ### Full Name
          NAME=$(echo "$ISSUE_BODY" | awk '
            BEGIN {found=0}
            /^### Full Name/ {found=1; next}
            found && NF {print; exit}
          ')
          NAME=$(echo "$NAME" | xargs)

          PHONE=$(echo "$ISSUE_BODY" | sed -n '/### Phone Number/{n;p;}' | xargs)

          SHIFTS=$(echo "$ISSUE_BODY" | awk '/### What shifts are you available for\?/{flag=1; next} /^### /{flag=0} flag')
          CLEANED_SHIFTS=$(echo "$SHIFTS" | sed '/^\s*$/d')

          echo "ðŸ‘¤ Name: '$NAME'"
          echo "ðŸ“± Phone: '$PHONE'"
          echo "ðŸ“† Shifts:"
          echo "$CLEANED_SHIFTS"

          if [ -z "$NAME" ] || [ -z "$CLEANED_SHIFTS" ]; then
            echo "âŒ Error: Missing required 'name' or 'shifts'"
            exit 1
          fi

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "phone=$PHONE" >> $GITHUB_OUTPUT
          echo "shifts<<EOF" >> $GITHUB_OUTPUT
          echo "$CLEANED_SHIFTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run parse_issue.py script
        run: |
          echo "âœ… Running submission parser..."
          python parse_issue.py \
            --name "${{ steps.extract.outputs.name }}" \
            --phone "${{ steps.extract.outputs.phone }}" \
            --shifts "${{ steps.extract.outputs.shifts }}"
