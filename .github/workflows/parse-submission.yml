name: Process Volunteer Submission

on:
  issues:
    types: [opened]

jobs:
  process-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install clicksend-client
          pip install ics
          pip install pyyaml

      - name: Extract volunteer name and shifts from issue body
        id: extract
        run: |
          # Debug: print event JSON path and issue body
          echo "Event JSON path: $GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

          # Extract issue body JSON
          ISSUE_BODY=$(jq -r .issue.body "$GITHUB_EVENT_PATH")

          echo "---- Lines around 'Full Name' heading ----"
          echo "$ISSUE_BODY" | grep -A3 -B3 "Full Name" || echo "No 'Full Name' heading found"

          # Extract volunteer name after "Full Name" heading (more robust)
          NAME=$(echo "$ISSUE_BODY" | awk '
            BEGIN {found=0}
            /Full Name/ {found=1; next}
            found && /^[[:space:]]*$/ {next}
            found {print; exit}
          ' | xargs)

          # Extract shifts after "What shifts are you available for?" heading
          SHIFTS=$(echo "$ISSUE_BODY" | awk '
            /What shifts are you available for\?/ {flag=1; next}
            /^### / {flag=0}
            flag
          ' | sed '/^\s*$/d' | tr '\n' ' ' | xargs)

          echo "Extracted Name: '$NAME'"
          echo "Extracted Shifts: '$SHIFTS'"

          # Output variables for next steps
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "shifts=$SHIFTS" >> $GITHUB_OUTPUT

      - name: Run parse_issue.py script
        run: |
          echo "Name: '${{ steps.extract.outputs.name }}'"
          echo "Shifts: '${{ steps.extract.outputs.shifts }}'"
          python parse_issue.py --name "${{ steps.extract.outputs.name }}" --shifts "${{ steps.extract.outputs.shifts }}"
